<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PR Live – Station Mapping</title>
</head>
<body>

<h3>Pakistan Railways – Live Station Resolver</h3>
<pre id="log">Initializing…</pre>

<script>
const TRAIN_ID = 27;
const log = document.getElementById("log");

let stationMap = {};   // StationDetailsId → StationName

// 1️⃣ Load stations ONCE
async function loadStations() {
  const res = await fetch(
    `https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${TRAIN_ID}`
  );
  const json = await res.json();

  json.Response.forEach(st => {
    stationMap[String(st.StationDetailsId)] = st.StationName;
  });

  console.log("Stations loaded", stationMap);
}

// 2️⃣ Connect WebSocket
function startSocket() {
  const ws = new WebSocket(
    "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
  );

  ws.onopen = () => {
    ws.send("40");                      // socket.io handshake
    ws.send('42["joinTrain","41"]');    // subscribe
    log.textContent = "Connected. Waiting for live data…";
  };

  ws.onmessage = e => {
    if (!e.data.startsWith("42")) return;

    const payload = JSON.parse(e.data.slice(2));
    const live = payload[1];

    const output = {
      previousStation : stationMap[live.prev_st] || live.prev_st,
      currentStation  : stationMap[live.loc]     || live.loc,
      nextStation     : stationMap[live.next_st] || live.next_st,
      delayMin        : live.late_by,
      speedKmh        : live.sp,
      nextETA         : live.NextStationETA,
      latitude        : live.lat,
      longitude       : live.lon,
      status          : live.st
    };

    log.textContent = JSON.stringify(output, null, 2);
  };

  ws.onerror = e => console.error("WS error", e);
  ws.onclose = () => console.warn("WS closed");
}

// 3️⃣ Start everything
(async function init() {
  await loadStations();   // VERY IMPORTANT
  startSocket();
})();
</script>

</body>
</html>
