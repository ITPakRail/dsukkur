<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pakistan Railways Live Train Status</title>
</head>
<body>
  <h2>Pak Railways Live Train Status</h2>
  <label for="trainId">Enter Train ID:</label>
  <input type="text" id="trainId" value="41" />
  <button id="startBtn">Start Tracking</button>

  <pre id="output">Waiting for live data...</pre>

  <script>
    const outputEl = document.getElementById("output");

    document.getElementById("startBtn").addEventListener("click", async () => {
      const trainId = document.getElementById("trainId").value.trim();
      if (!trainId) return alert("Please enter a Train ID");

      outputEl.textContent = "Fetching stations...";

      // 1️⃣ Fetch station data for this train
      let stations = [];
      let stationMap = {};

      try {
        const res = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`);
        const data = await res.json();
        stations = data.Response || [];

        // Create lookup map for station ID => station name
        stations.forEach(s => {
          stationMap[s.StationDetailsId] = s.StationName;
        });

      } catch (e) {
        console.error("Failed to fetch stations", e);
        outputEl.textContent = "Error fetching stations.";
        return;
      }

      outputEl.textContent = "Connecting to WebSocket...";

      // 2️⃣ Connect to WebSocket
      const ws = new WebSocket("wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket");

      ws.onopen = () => {
        console.log("Connected to WebSocket!");
        outputEl.textContent = "Connected. Waiting for live data...";
      };

      ws.onmessage = (event) => {
        const raw = event.data;

        // Only parse '42' messages (Socket.IO)
        if (raw.startsWith("42")) {
          try {
            const jsonStr = raw.slice(2);
            const arr = JSON.parse(jsonStr);

            const msgTrainId = arr[0];      // Train ID from server
            const trainData = arr[1];       // Live data

            // Only show data for selected train
            if (msgTrainId != trainId) return;

            // Map station IDs to names
            const prevStation = stationMap[trainData.prev_st] || trainData.prev_st;
            const currentStation = stationMap[trainData.loc] || trainData.loc;
            const nextStation = stationMap[trainData.next_st] || trainData.next_st;

            // Prepare JSON
            const liveOutput = {
              trainId: msgTrainId,
              prevStation,
              currentStation,
              nextStation,
              delayMin: trainData.late_by,
              nextStationETA: trainData.NextStationETA,
              latitude: trainData.lat,
              longitude: trainData.lon,
              speedKmh: trainData.sp,
              status: trainData.st
            };

            // Show live JSON
            outputEl.textContent = JSON.stringify(liveOutput, null, 2);

          } catch (err) {
            console.error("Failed to parse WebSocket message", err);
          }
        }
      };

      ws.onerror = (err) => {
        console.error("WebSocket error:", err);
        outputEl.textContent = "WebSocket error. See console.";
      };

      ws.onclose = () => {
        console.log("WebSocket closed");
        outputEl.textContent += "\nWebSocket connection closed.";
      };
    });
  </script>
</body>
</html>
