<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PR Current Train Status</title>
</head>
<body>

<h3>Pakistan Railways â€“ Current Train Status</h3>
<pre id="log">Loading current statusâ€¦</pre>

<script>
const log = document.getElementById("log");
const TRAIN_ID = "27";

let stationMap = {};
let snapshotTaken = false;

// 1ï¸âƒ£ Load station list once
async function loadStations() {
  const res = await fetch(
    `https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${TRAIN_ID}`
  );
  const json = await res.json();

  (json.Response || []).forEach(st => {
    stationMap[String(st.StationDetailsId)] = st.StationName;
  });
}

// 2ï¸âƒ£ Open WebSocket
const ws = new WebSocket(
  "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
);

ws.onopen = () => {
  ws.send("40");
  ws.send(`42["joinTrain","${TRAIN_ID}"]`);
};

ws.onmessage = (e) => {
  if (snapshotTaken) return;
  if (!e.data.startsWith("42")) return;

  const payload = JSON.parse(e.data.slice(2));
  const live = payload[1];

  // ðŸŸ¢ TAKE FIRST SNAPSHOT ONLY
  snapshotTaken = true;

  const output = {
    lastCrossedStation : stationMap[live.prev_st] || live.prev_st,
    nextStation        : stationMap[live.next_st] || live.next_st,
    latitude           : live.lat,
    longitude          : live.lon,
    delayMinutes       : live.late_by,
    speedKmh           : live.sp,
    nextStationETA     : live.NextStationETA,
    status             : live.st === "A" ? "RUNNING" : "UNKNOWN",
    capturedAt         : new Date().toLocaleString()
  };

  log.textContent = JSON.stringify(output, null, 2);

  // ðŸ›‘ Stop further updates
  ws.close();
};

ws.onerror = () => {
  log.textContent = "Unable to fetch live status.";
};

loadStations();
</script>

</body>
</html>
