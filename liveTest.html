<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pakistan Railways Live Train Status</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>
  <h2>Pak Railways Live Train Status</h2>
  <table id="trainTable">
    <thead>
      <tr>
        <th>Train ID</th>
        <th>Previous Station</th>
        <th>Current Station</th>
        <th>Next Station</th>
        <th>Delay (min)</th>
        <th>Next Station ETA</th>
        <th>Speed (km/h)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="7">Waiting for live data...</td></tr>
    </tbody>
  </table>

  <script>
    const trainId = 41; // Change to any train ID
    let stationsMap = {};

    // 1️⃣ Fetch station list
    fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`)
      .then(res => res.json())
      .then(data => {
        if(data.IsSuccess) {
          data.Response.forEach(st => {
            stationsMap[st.StationDetailsId] = st.StationName;
          });
        } else {
          console.error("Station list fetch failed:", data.ErrorMessage);
        }
      });

    // 2️⃣ Setup Socket.IO client
    const socket = io("https://cotrolroomapi.pakraillive.com", {
      transports: ["websocket"]
    });

    socket.on("connect", () => {
      console.log("Connected to live train socket:", socket.id);
      socket.emit("subscribeTrain", { trainId }); // subscribe to live updates
    });

    // 3️⃣ Handle live train updates
    socket.on("trainUpdate", (msg) => {
      // Example msg: { prev_st, next_st, lat, lon, late_by, sp, NextStationETA }
      console.log("Live data:", msg);

      const tbody = document.querySelector("#trainTable tbody");
      tbody.innerHTML = ""; // clear old row

      const prevStation = stationsMap[msg.prev_st] || msg.prev_st;
      const nextStation = stationsMap[msg.next_st] || msg.next_st;
      const currentStation = prevStation; // approximate current station

      const row = `
        <tr>
          <td>${trainId}</td>
          <td>${prevStation}</td>
          <td>${currentStation}</td>
          <td>${nextStation}</td>
          <td>${msg.late_by || 0}</td>
          <td>${msg.NextStationETA || ""}</td>
          <td>${msg.sp || 0}</td>
        </tr>
      `;
      tbody.innerHTML = row;
    });

    socket.on("disconnect", () => {
      console.log("Disconnected from live train socket");
    });
  </script>
</body>
</html>
