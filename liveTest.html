<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakistan Railways – Current Train Status</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    pre { background: #f4f4f4; padding: 15px; border-radius: 5px; }
    input { width: 50px; margin-right: 10px; }
    button { padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>

<h3>Pakistan Railways – Current Train Status</h3>

<label for="trainId">Train ID:</label>
<input type="text" id="trainId" value="27">
<button id="getStatus">Get Current Status</button>

<pre id="output">Loading current status…</pre>

<script>
const output = document.getElementById("output");

document.getElementById("getStatus").addEventListener("click", () => {
  const TRAIN_ID = document.getElementById("trainId").value.trim();
  if (!TRAIN_ID) return alert("Please enter a Train ID");

  output.textContent = "Connecting to live feed…";

  let snapshotTaken = false;
  let stationMap = {};

  // Load stations for this train
  fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${TRAIN_ID}`)
    .then(res => res.json())
    .then(json => {
      (json.Response || []).forEach(st => {
        stationMap[String(st.StationDetailsId)] = st.StationName;
      });

      // Start WebSocket
      const ws = new WebSocket(
        "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
      );

      ws.onopen = () => {
        ws.send("40"); // handshake
        ws.send(`42["joinTrain","${TRAIN_ID}"]`); // subscribe
      };

      ws.onmessage = e => {
        if (!e.data.startsWith("42") || snapshotTaken) return;

        const payload = JSON.parse(e.data.slice(2));
        const live = payload[1];

        if (!live) return;

        const result = {
          trainId: TRAIN_ID,
          trainName: live.TrainName || "Shalimar Express " + TRAIN_ID, // fallback
          lastCrossedStation: stationMap[live.prev_st] || live.prev_st,
          nextStation: stationMap[live.next_st] || live.next_st,
          currentLocation: live.sp > 0 ? "Between stations" : "At station",
          latitude: live.lat,
          longitude: live.lon,
          delayMinutes: live.late_by,
          speedKmh: live.sp,
          nextStationETA: live.NextStationETA,
          status: live.st === "A" ? "RUNNING" : "STOPPED"
        };

        output.textContent = JSON.stringify(result, null, 2);

        snapshotTaken = true;
        ws.close(); // stop after first snapshot
      };

      ws.onerror = () => {
        output.textContent = "Failed to fetch live status.";
      };

    })
    .catch(err => {
      console.error(err);
      output.textContent = "Failed to load station list.";
    });
});
</script>

</body>
</html>
