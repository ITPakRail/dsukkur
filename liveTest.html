<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pakistan Railways Live Train Status</title>
<style>
body { font-family: Arial; }
pre { background:#111; color:#0f0; padding:10px; }
</style>
</head>

<body>

<h2>Pak Railways Live Train Status</h2>

<label>Enter Train ID:</label>
<input id="trainId" value="41">
<button id="startBtn">Start Tracking</button>

<pre id="output">Waiting for live data...</pre>

<script>
const output = document.getElementById("output");
let stationMap = {};
let ws;

document.getElementById("startBtn").onclick = async () => {
  const trainId = document.getElementById("trainId").value.trim();
  if (!trainId) return alert("Enter Train ID");

  output.textContent = "Fetching station list...";

  /* 1ï¸âƒ£ Stations */
  const res = await fetch(
    `https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`
  );
  const json = await res.json();

  stationMap = {};
  (json.Response || []).forEach(s => {
    stationMap[s.StationDetailsId] = s.StationName;
  });

  output.textContent = "Connecting to live server...";

  /* 2ï¸âƒ£ WebSocket */
  ws = new WebSocket(
    "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
  );

  ws.onopen = () => {
    console.log("WS open");

    /* ðŸ”‘ REQUIRED Socket.IO CONNECT */
    ws.send("40");

    output.textContent = "Connected. Waiting for train updates...";
  };

  ws.onmessage = (e) => {
    const msg = e.data;

    /* ðŸ” Ping â†’ Pong */
    if (msg === "2") {
      ws.send("3");
      return;
    }

    /* ðŸŽ¯ Train data */
    if (!msg.startsWith("42")) return;

    const payload = JSON.parse(msg.slice(2));
    const msgTrainId = payload[0];
    const d = payload[1];

    if (msgTrainId != trainId) return;

    const live = {
      trainId: msgTrainId,
      previousStation: stationMap[d.prev_st] || d.prev_st,
      currentStation: stationMap[d.loc] || d.loc,
      nextStation: stationMap[d.next_st] || d.next_st,
      delayMinutes: d.late_by,
      nextStationETA: d.NextStationETA,
      speedKmh: d.sp,
      latitude: d.lat,
      longitude: d.lon,
      status: d.st
    };

    output.textContent = JSON.stringify(live, null, 2);
  };

  ws.onclose = () => {
    output.textContent += "\nConnection closed.";
  };

  ws.onerror = err => {
    console.error(err);
    output.textContent = "WebSocket error";
  };
};
</script>

</body>
</html>
