<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakistan Railways – Current Train Status</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h3 { color: #2c3e50; }
    pre { background: #f4f4f4; padding: 15px; border-radius: 5px; }
    label { font-weight: bold; }
    input { width: 50px; margin-right: 10px; }
    button { padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>

<h3>Pakistan Railways – Current Train Status</h3>

<label for="trainId">Train ID:</label>
<input type="text" id="trainId" value="27">
<button id="getStatus">Get Current Status</button>

<pre id="output">Loading current status…</pre>

<script>
const output = document.getElementById("output");

async function getTrainStatus() {
  const trainId = document.getElementById("trainId").value.trim();
  if (!trainId) {
    alert("Please enter a Train ID");
    return;
  }

  output.textContent = "Fetching current train status…";

  try {
    // 1️⃣ Fetch the stations for this train
    const stationsRes = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`);
    const stationsJson = await stationsRes.json();
    const stationMap = {};
    (stationsJson.Response || []).forEach(st => {
      stationMap[String(st.StationDetailsId)] = st.StationName;
    });

    // 2️⃣ Fetch the current train snapshot from the same API
    // Note: Some master site pages use the same endpoint with extra fields
    const trainDataRes = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`);
    const trainJson = await trainDataRes.json();
    const trainInfo = trainJson; // trainJson includes fields like prevStationId, nextStationId, latitude, longitude, delay, speed

    // Map previous and next stations
    const lastCrossed = stationMap[trainInfo.prevStationId] || trainInfo.prevStationId;
    const nextStation = stationMap[trainInfo.nextStationId] || trainInfo.nextStationId;

    // Build output object
    const result = {
      trainId: trainInfo.TrainId || trainId,
      trainName: trainInfo.TrainName || "N/A",
      lastCrossedStation: lastCrossed,
      nextStation: nextStation,
      currentLocation: trainInfo.speed > 0 ? "Between stations" : "At station",
      latitude: trainInfo.latitude || 0,
      longitude: trainInfo.longitude || 0,
      delayMinutes: trainInfo.delay || 0,
      speedKmh: trainInfo.speed || 0,
      status: trainInfo.speed > 0 ? "RUNNING" : "STOPPED",
      nextETA: trainInfo.NextStationETA || "N/A"
    };

    output.textContent = JSON.stringify(result, null, 2);

  } catch (err) {
    console.error(err);
    output.textContent = "Failed to fetch current status.";
  }
}

document.getElementById("getStatus").addEventListener("click", getTrainStatus);
</script>

</body>
</html>
