<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pakistan Railways – Current Train Status</title>
<style>
body { font-family: Arial; margin: 20px; }
pre { background: #f4f4f4; padding: 15px; }
</style>
</head>
<body>

<h3>Pakistan Railways – Current Train Status</h3>
<pre id="output">Loading…</pre>

<script>
const TRAIN_ID = "27";
const output = document.getElementById("output");

let stationMap = {};
let bestLive = null;
let startTime = Date.now();

// Load stations
fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${TRAIN_ID}`)
.then(r => r.json())
.then(j => {
  (j.Response || []).forEach(s => {
    stationMap[String(s.StationDetailsId)] = s.StationName;
  });
  startSocket();
});

function startSocket() {
  const ws = new WebSocket(
    "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
  );

  ws.onopen = () => {
    ws.send("40");
    ws.send(`42["joinTrain","${TRAIN_ID}"]`);
  };

  ws.onmessage = e => {
    if (!e.data.startsWith("42")) return;

    const live = JSON.parse(e.data.slice(2))[1];
    if (!live || !live.lat) return;

    if (!bestLive || live.lastUpdate > bestLive.lastUpdate) {
      bestLive = live;
    }

    // After 15 seconds → finalize
    if (Date.now() - startTime > 15000) {
      ws.close();
      render(bestLive);
    }
  };

  ws.onerror = () => {
    output.textContent = "Live feed error.";
  };
}

function render(live) {
  output.textContent = JSON.stringify({
    trainId: TRAIN_ID,
    lastCrossedStation: stationMap[live.prev_st] || live.prev_st,
    nextStation: stationMap[live.next_st] || live.next_st,
    latitude: live.lat,
    longitude: live.lon,
    delayMinutes: live.late_by,
    speedKmh: live.sp,
    status: live.st === "A" ? "RUNNING" : "STOPPED",
    note: "Best-effort snapshot (WebSocket is not authoritative)"
  }, null, 2);
}
</script>

</body>
</html>
