<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakistan Railways â€“ Current Train Status</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    pre { background: #f4f4f4; padding: 15px; border-radius: 6px; }
  </style>
</head>
<body>

<h3>Pakistan Railways â€“ Current Train Status</h3>
<pre id="output">Waiting for live dataâ€¦</pre>

<script>
const TRAIN_ID = "27";
const output = document.getElementById("output");

const ws = new WebSocket(
  "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
);

ws.onopen = () => {
  ws.send("40"); // handshake
};

ws.onmessage = (e) => {
  if (!e.data.startsWith("42")) return;

  const payload = JSON.parse(e.data.slice(2));
  if (payload[0] !== "all-trains") return;

  const allTrains = payload[1];
  if (!allTrains[TRAIN_ID]) return;

  // Each train has ONE runtime object
  const runtimeId = Object.keys(allTrains[TRAIN_ID])[0];
  const live = allTrains[TRAIN_ID][runtimeId];

  const result = {
    trainId: TRAIN_ID,
    lastCrossedStationId: live.prev_st,
    nextStationId: live.next_st,
    latitude: live.lat,
    longitude: live.lon,
    delayMinutes: live.late_by,
    speedKmh: live.sp,
    nextStationETA: live.NextStationETA,
    status: live.st === "A" ? "RUNNING" : "STOPPED",
    lastUpdated: new Date(live.last_updated * 1000).toLocaleString()
  };

  output.textContent = JSON.stringify(result, null, 2);

  ws.close(); // ðŸ”´ ONE snapshot = correct
};

ws.onerror = () => {
  output.textContent = "Connection failed.";
};
</script>

</body>
</html>
