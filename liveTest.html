<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakistan Railways – Current Train Status</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { width: 100%; height: 400px; margin-top: 20px; }
    pre { background: #f5f5f5; padding: 15px; border-radius: 5px; }
  </style>
</head>
<body>

<h2>Pakistan Railways – Current Train Status</h2>
<label for="trainId">Train ID:</label>
<input type="text" id="trainId" value="27" />
<button id="getStatusBtn">Get Current Status</button>

<pre id="output">Loading current status…</pre>
<div id="map"></div>

<script>
let map, marker;
const output = document.getElementById("output");

async function getTrainStatus() {
  const trainId = document.getElementById("trainId").value.trim();
  if (!trainId) return alert("Enter Train ID");

  output.textContent = "Fetching current status…";

  try {
    // 1️⃣ Fetch station list for this train
    const stationsRes = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`);
    const stationsJson = await stationsRes.json();
    const stationMap = {};
    (stationsJson.Response || []).forEach(st => {
      stationMap[String(st.StationDetailsId)] = st.StationName;
    });

    // 2️⃣ Fetch current train snapshot (use first train event from live API)
    const liveRes = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainLiveStatus?id=${trainId}`);
    const liveJson = await liveRes.json();
    const liveData = liveJson.Response || liveJson;

    if (!liveData) {
      output.textContent = "No live data available.";
      return;
    }

    const result = {
      trainId: trainId,
      trainName: liveData.TrainName || "Unknown",
      lastCrossedStation: stationMap[liveData.PrevStationId] || liveData.PrevStationId,
      nextStation: stationMap[liveData.NextStationId] || liveData.NextStationId,
      currentLocation: liveData.Speed > 0 ? "Between stations" : "At station",
      latitude: liveData.Latitude,
      longitude: liveData.Longitude,
      delayMinutes: liveData.DelayMinutes,
      speedKmh: liveData.Speed,
      nextStationETA: liveData.NextStationETA,
      status: liveData.Status || (liveData.Speed > 0 ? "RUNNING" : "STOPPED")
    };

    output.textContent = JSON.stringify(result, null, 2);

    // 3️⃣ Show marker on Google Map
    if (!map) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: result.latitude, lng: result.longitude },
        zoom: 6,
      });
      marker = new google.maps.Marker({
        position: { lat: result.latitude, lng: result.longitude },
        map,
        title: `Train ${result.trainName} (${result.trainId})`
      });
    } else {
      marker.setPosition({ lat: result.latitude, lng: result.longitude });
      map.panTo({ lat: result.latitude, lng: result.longitude });
    }

  } catch (err) {
    console.error(err);
    output.textContent = "Failed to fetch current status.";
  }
}

document.getElementById("getStatusBtn").addEventListener("click", getTrainStatus);
</script>

<!-- Google Maps API: replace YOUR_API_KEY below with your actual API key -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
</body>
</html>
