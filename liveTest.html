<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pakistan Railways – Live Train Status</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, button { padding: 6px; margin-right: 5px; }
  </style>
</head>
<body>

<h2>Pakistan Railways – Live Train Status</h2>
<label for="trainId">Train ID:</label>
<input type="text" id="trainId" value="41">
<button id="startBtn">Start Tracking</button>

<table>
  <thead>
    <tr>
      <th>Train ID</th>
      <th>Previous Station</th>
      <th>Current Station</th>
      <th>Next Station</th>
      <th>Delay (min)</th>
      <th>Next ETA</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Speed (km/h)</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="trainData">
    <tr><td colspan="10">Waiting for live data…</td></tr>
  </tbody>
</table>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
document.getElementById("startBtn").addEventListener("click", async () => {
  const trainId = document.getElementById("trainId").value.trim();
  if (!trainId) return alert("Enter Train ID");

  const tbody = document.getElementById("trainData");
  tbody.innerHTML = `<tr><td colspan="10">Connecting…</td></tr>`;

  // 1️⃣ Fetch station data for this train
  let stationMap = {};
  try {
    const res = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${trainId}`);
    const data = await res.json();
    const stations = data.Response || [];

    stations.forEach(s => {
      stationMap[s.StationDetailsId] = s.StationName;
    });
  } catch (err) {
    console.error("Failed to fetch stations:", err);
    tbody.innerHTML = `<tr><td colspan="10">Error fetching station data</td></tr>`;
    return;
  }

  // 2️⃣ Connect to Socket.IO
  const socket = io("https://cotrolroomapi.pakraillive.com", {
    path: "/socket.io",
    transports: ["websocket"],
  });

  socket.on("connect", () => {
    console.log("Socket.IO connected");
    tbody.innerHTML = `<tr><td colspan="10">Connected. Waiting for train updates…</td></tr>`;

    // Subscribe to train updates
    socket.emit("joinTrain", trainId);
  });

  socket.on("disconnect", () => {
    console.warn("Socket.IO disconnected");
    tbody.innerHTML = `<tr><td colspan="10">Disconnected from server</td></tr>`;
  });

  // 3️⃣ Listen for live train updates
  socket.onAny((event, data) => {
    // data can be array [trainId, liveData]
    if (!Array.isArray(data) || data.length < 2) return;

    const msgTrainId = data[0];
    const live = data[1];

    if (msgTrainId != trainId) return;

    const prevStation = stationMap[live.prev_st] || live.prev_st;
    const currentStation = stationMap[live.loc] || live.loc;
    const nextStation = stationMap[live.next_st] || live.next_st;

    tbody.innerHTML = `
      <tr>
        <td>${msgTrainId}</td>
        <td>${prevStation}</td>
        <td>${currentStation}</td>
        <td>${nextStation}</td>
        <td>${live.late_by}</td>
        <td>${live.NextStationETA}</td>
        <td>${live.lat}</td>
        <td>${live.lon}</td>
        <td>${live.sp}</td>
        <td>${live.st}</td>
      </tr>
    `;
  });

  socket.on("connect_error", err => {
    console.error("Connection error:", err);
    tbody.innerHTML = `<tr><td colspan="10">Connection error</td></tr>`;
  });
});
</script>

</body>
</html>
