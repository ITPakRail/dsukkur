<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakistan Railways â€“ Current Train Status</title>
</head>
<body>

<h3>Pakistan Railways â€“ Current Train Status</h3>
<pre id="log">Loading current statusâ€¦</pre>

<script>
const log = document.getElementById("log");
const TRAIN_ID = "27";

let stationMap = {};
let captured = false;   // â­ IMPORTANT

// 1ï¸âƒ£ Load stations once
async function loadStations() {
  const res = await fetch(
    `https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${TRAIN_ID}`
  );
  const json = await res.json();

  (json.Response || []).forEach(st => {
    stationMap[String(st.StationDetailsId)] = st.StationName;
  });
}

// 2ï¸âƒ£ WebSocket snapshot
function getSnapshot() {
  const ws = new WebSocket(
    "wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket"
  );

  ws.onopen = () => {
    ws.send("40");
    ws.send(`42["joinTrain","${TRAIN_ID}"]`);
  };

  ws.onmessage = (e) => {
    if (captured) return;
    if (!e.data.startsWith("42")) return;

    const payload = JSON.parse(e.data.slice(2));
    const live = payload[1];

    // ğŸ“Œ SNAPSHOT DATA
    const snapshot = {
      trainId: TRAIN_ID,
      lastCrossedStation: stationMap[live.prev_st] || live.prev_st,
      nextStation: stationMap[live.next_st] || live.next_st,
      currentLocation: stationMap[live.loc] || "Between stations",
      latitude: live.lat,
      longitude: live.lon,
      delayMinutes: live.late_by,
      speedKmh: live.sp,
      nextStationETA: live.NextStationETA,
      status: live.st === "A" ? "RUNNING" : "UNKNOWN"
    };

    log.textContent = JSON.stringify(snapshot, null, 2);

    captured = true;   // â­ freeze data
    ws.close();        // â­ stop updates
  };

  ws.onerror = () => {
    log.textContent = "Failed to load current status.";
  };
}

// 3ï¸âƒ£ Start
(async function init() {
  await loadStations();
  getSnapshot();
})();
</script>

</body>
</html>
