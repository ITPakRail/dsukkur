<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakistan Railways – Current Train Status</title>
  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>

<h3>Pakistan Railways – Current Train Status</h3>
<pre id="output">Loading current status…</pre>
<div id="map"></div>

<script>
const TRAIN_ID = "27"; // change train number here
const output = document.getElementById("output");

let stationMap = {};
let snapshotTaken = false;
let map, marker;

// 1️⃣ Load station list once
async function loadStations() {
  try {
    const res = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${TRAIN_ID}`);
    const json = await res.json();
    (json.Response || []).forEach(st => {
      stationMap[String(st.StationDetailsId)] = st.StationName;
    });
    console.log("Station map loaded:", stationMap);
  } catch (err) {
    console.error("Failed to load stations:", err);
  }
}

// 2️⃣ Initialize Google Map
function initMap(lat = 0, lon = 0) {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng: lon },
    zoom: 6
  });
  marker = new google.maps.Marker({
    position: { lat, lng: lon },
    map,
    title: "Train location"
  });
}

// 3️⃣ Start WebSocket to get live data
async function startWebSocket() {
  await loadStations();

  const ws = new WebSocket("wss://cotrolroomapi.pakraillive.com/socket.io/?EIO=4&transport=websocket");

  ws.onopen = () => {
    ws.send("40"); // Socket.IO handshake
    ws.send(`42["joinTrain","${TRAIN_ID}"]`); // subscribe to train
    output.textContent = "Connected & waiting for live data…";
  };

  ws.onmessage = (e) => {
    if (!e.data.startsWith("42") || snapshotTaken) return;

    const payload = JSON.parse(e.data.slice(2));
    const live = payload[1];

    if (!live || live.loc === undefined) return;

    // Map station IDs → names
    const lastCrossedStation = stationMap[live.prev_st] || live.prev_st;
    const nextStation = stationMap[live.next_st] || live.next_st;

    const result = {
      trainId: TRAIN_ID,
      lastCrossedStation: lastCrossedStation,
      nextStation: nextStation,
      currentLocation: live.sp > 0 ? "Between stations" : "At station",
      latitude: live.lat,
      longitude: live.lon,
      delayMinutes: live.late_by,
      speedKmh: live.sp,
      nextStationETA: live.NextStationETA,
      status: live.st === "A" ? "RUNNING" : "STOPPED"
    };

    // Show snapshot
    output.textContent = JSON.stringify(result, null, 2);

    // Show on map
    if (!map) initMap(live.lat, live.lon);
    marker.setPosition({ lat: live.lat, lng: live.lon });
    map.panTo({ lat: live.lat, lng: live.lon });

    snapshotTaken = true; // take only 1 snapshot
    ws.close(); // stop receiving further updates
  };

  ws.onerror = () => {
    output.textContent = "Failed to load live status.";
  };

  ws.onclose = () => {
    console.log("WebSocket closed after snapshot");
  };
}

// Start everything
startWebSocket();
</script>

</body>
</html>
