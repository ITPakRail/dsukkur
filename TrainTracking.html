<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pakistan Railways Live Train Status</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
  }

  /* Header */
  .header {
    background-color: #2e7d32; /* Green */
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header img {
    height: 50px;
  }

  .header h1 {
    margin: 0;
    font-size: 22px;
    text-align: center;
    flex-grow: 1;
  }

  /* Controls */
  .controls {
    margin: 20px;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  label {
    font-weight: bold;
    margin-right: 5px;
  }

  select, input[type="date"], button {
    padding: 5px 10px;
    font-size: 16px;
  }

  button {
    cursor: pointer;
    background-color: #2e7d32;
    color: white;
    border: none;
    border-radius: 4px;
  }

  button:hover {
    background-color: #1b5e20;
  }

  /* Status Table */
  table {
    width: 95%;
    margin: 20px auto;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }

  th {
    background-color: #2e7d32;
    color: white;
  }

  tr:nth-child(even) {
    background-color: #f2f2f2;
  }

</style>
</head>
<body>

<div class="header">
  <img src="logo-left.png" alt="Left Logo">
  <h1>Pakistan Railways Sukkur Division</h1>
  <img src="logo-right.png" alt="Right Logo">
</div>

<div class="controls">
  <div>
    <label for="datePicker">Date:</label>
    <input type="date" id="datePicker">
  </div>

  <div>
    <label for="trainSelect">Train:</label>
    <select id="trainSelect">
      <option value="">Select Train</option>
    </select>
  </div>

  <button id="checkStatus">Check Status</button>
</div>

<div id="statusContainer">
  <table id="statusTable">
    <thead>
      <tr>
        <th>Train ID</th>
        <th>Train Name</th>
        <th>Previous Station</th>
        <th>Current Location</th>
        <th>Next Station</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6">Select a train to see status</td></tr>
    </tbody>
  </table>
</div>

<script>
const GAS_API = "https://script.google.com/macros/s/AKfycbya7KRQupcY_anV146gjtN0EeH6hQakjh20emQsgJqY0seA8MRV0vqst3zyE4zL2t6b/exec";

// Set date picker to today
document.getElementById('datePicker').valueAsDate = new Date();

// Fetch live trains and populate dropdown
fetch(`${GAS_API}?action=liveTrains`)
  .then(r => r.json())
  .then(trains => {
    const select = document.getElementById('trainSelect');
    trains.forEach(t => {
      const option = document.createElement('option');
      option.value = t.TrainId;

      // Avoid repeating number if already included
      const numberPart = t.TrainNumber + (t.IsUp ? 'UP' : 'DN');
      if (t.TrainNameWithNumber.endsWith(numberPart)) {
        option.textContent = t.TrainNameWithNumber;
      } else {
        option.textContent = `${t.TrainName} ${t.TrainNumber}${t.IsUp ? 'UP' : 'DN'}`;

      }

      select.appendChild(option);
    });
  })
  .catch(err => console.error("Failed to fetch live trains:", err));

// Check status button click
document.getElementById('checkStatus').addEventListener('click', () => {
  const trainId = document.getElementById('trainSelect').value;
  if (!trainId) return alert("Please select a train!");

  fetch(`${GAS_API}?action=liveStatus&trainId=${trainId}`)
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector('#statusTable tbody');
      tbody.innerHTML = ""; // Clear old rows

      // Determine Previous, Current, Next
      const prev = data.lastCrossed?.StationName || "N/A";
      let next = data.nextStation?.StationName || "N/A";
      let current = "N/A";
      let status = data.status;

      // Check if train departed origin but not crossed first station
      if (!data.lastCrossed && status === "NOT_STARTED") {
        const now = new Date();
        const depTimeStr = data.scheduledDeparture;
        const [hours, minutes] = depTimeStr.split(':').map(Number);
        const depTime = new Date();
        depTime.setHours(hours, minutes, 0, 0);

        if (now >= depTime) {
          status = "RUNNING";
          current = data.origin;
          next = data.nextStation?.StationName || "N/A";
        } else {
          current = data.origin;
        }
      } else if (status === "RUNNING") {
        current = data.nextStation?.StationName || "En Route";
      } else if (status === "NOT_STARTED") {
        current = data.origin;
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${trainId}</td>
        <td>${document.getElementById('trainSelect').selectedOptions[0].text}</td>
        <td>${prev}</td>
        <td>${current}</td>
        <td>${next}</td>
        <td>${status}</td>
      `;
      tbody.appendChild(row);
    })
    .catch(err => {
      console.error(err);
      alert("Failed to fetch train status.");
    });
});
</script>

</body>
</html>
